<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<title>Chatran پویا 🤖</title>
<style>
body{background:#0f172a;color:#e2e8f0;font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
#chat-container{width:400px;background:#1e293b;border-radius:12px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 10px #06b6d4;}
#chatbox{flex-grow:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;max-height:400px;}
.msg{margin:5px 0;padding:6px 10px;border-radius:8px;word-wrap:break-word;max-width:80%;}
.user{background:#06b6d4;color:#000;align-self:flex-end;}
.bot{background:#334155;color:#e2e8f0;align-self:flex-start;}
#input-area{display:flex;padding:5px;background:#0f172a;}
input{flex-grow:1;padding:6px;border-radius:6px;border:none;outline:none;background:#1e293b;color:white;}
button{background:#06b6d4;border:none;color:black;border-radius:6px;margin-left:5px;padding:6px 10px;cursor:pointer;}
button:hover{background:#22d3ee;}
</style>
</head>
<body>
<div id="chat-container">
  <div id="chatbox"></div>
  <div id="input-area">
    <input id="msg" placeholder="پیام خود را بنویس..." autocomplete="off">
    <button onclick="send()">ارسال</button>
  </div>
</div>

<script>
let model = [
  ["سلام","چطوری","خوبه؟"],
  ["سازنده","تو","Chatran"]
];
let waitingForUserLearning = null; // ذخیره triple موقت برای یادگیری

const blacklist = ["گاییدم","کسکش","کیر","کص","کونی","کیرم","پوفک","fuck","shit","bitch","asshole","idiot","dumb"];

function generateText(prompt,length=10){
  let words = prompt.split(/\s+/);
  let lastTwo = words.slice(-2);
  let candidates = model.filter(m=>m[0]===lastTwo[0] && m[1]===lastTwo[1]);
  if(candidates.length===0){
    // آماده یادگیری جمله بعدی کاربر
    waitingForUserLearning = lastTwo;
    return "می‌تونی بیشتر توضیح بدی؟";
  }
  let next = candidates[Math.floor(Math.random()*candidates.length)][2];
  return next;
}

function learnFromUser(input){
  if(!waitingForUserLearning) return;
  const words = input.split(/\s+/);
  if(words.length<1) return;
  const triple=[waitingForUserLearning[0],waitingForUserLearning[1],words.join(" ")];
  const wordSet=triple.map(w=>w.toLowerCase());
  if(wordSet.some(w=>blacklist.includes(w))) return;
  const exists=model.some(m=>m[0]===triple[0] && m[1]===triple[1] && m[2]===triple[2]);
  if(!exists) model.push(triple);
  waitingForUserLearning=null;

  // ثبت روی سرور
  fetch("/learn",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({triple})});
}

function addMessage(text,sender){
  const div=document.createElement("div");
  div.className="msg "+sender;
  div.innerText=text;
  document.getElementById("chatbox").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

function send(){
  const input=document.getElementById("msg");
  const text=input.value.trim();
  if(!text) return;
  addMessage(text,"user");
  input.value="";

  // یادگیری جمله بعدی اگر لازم بود
  learnFromUser(text);

  setTimeout(()=>{
    const reply=generateText(text);
    addMessage(reply,"bot");
  },200);
}
</script>
</body>
</html>
