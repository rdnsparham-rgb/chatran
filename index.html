<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<title>Chatran ØªÚ©â€ŒÙØ§ÛŒÙ„ÛŒ ğŸ¤–</title>
<style>
body{background:#0f172a;color:#e2e8f0;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;height:100vh;margin:0}
#chatbox{width:90%;max-width:600px;background:#1e293b;border-radius:12px;padding:15px;overflow-y:auto;flex-grow:1;margin-top:20px;display:flex;flex-direction:column}
.msg{margin:8px 0;padding:8px 12px;border-radius:10px;max-width:80%;word-wrap:break-word}
.user{background:#06b6d4;color:#000;align-self:flex-end}
.bot{background:#334155;color:#e2e8f0;align-self:flex-start}
#input-area{display:flex;width:90%;max-width:600px;margin:10px}
input{flex-grow:1;padding:10px;border-radius:8px;border:none;outline:none;background:#1e293b;color:white}
button{background:#06b6d4;border:none;color:black;border-radius:8px;margin-left:5px;padding:10px 15px;cursor:pointer}
button:hover{background:#22d3ee}
</style>
</head>
<body>
<h2>ğŸ¤– Chatran Ø²Ù†Ø¯Ù‡</h2>
<div id="chatbox"></div>
<div id="input-area">
  <input id="msg" placeholder="Ú†ÛŒØ²ÛŒ Ø¨Ù†ÙˆÛŒØ³..." autocomplete="off">
  <button onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
</div>

<script>
// Ù…Ø¯Ù„ Ø§ÙˆÙ„ÛŒÙ‡
let model = [
  ["Ø³Ù„Ø§Ù…","Ú†Ø·ÙˆØ±ÛŒ","Ø®ÙˆØ¨Ù‡ØŸ"],
  ["Ø³Ø§Ø²Ù†Ø¯Ù‡","ØªÙˆ","Chatran"]
];

// ÙÙ‡Ø±Ø³Øª ÙØ­Ø´â€ŒÙ‡Ø§ (ÙØ§Ø±Ø³ÛŒ Ùˆ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)
const blacklist = [
  "Ú¯Ø§ÛŒÛŒØ¯Ù…","Ú©Ø³Ú©Ø´","Ú©ÛŒØ±","Ú©Øµ","Ú©ÙˆÙ†ÛŒ","Ú©ÛŒØ±Ù…","Ù¾ÙˆÙÚ©","fuck","shit","bitch","asshole","idiot","dumb","Ú¯Ø§ÛŒÛŒØ¯"
];

// ØªØ§Ø¨Ø¹ ØªÙˆÙ„ÛŒØ¯ Ø¬Ù…Ù„Ù‡
function generateText(prompt,length=10){
  let words = prompt.split(/\s+/);
  for(let i=0;i<length;i++){
    let lastTwo = words.slice(-2);
    let candidates = model.filter(m=>m[0]===lastTwo[0] && m[1]===lastTwo[1]);
    if(candidates.length===0) break;
    let next = candidates[Math.floor(Math.random()*candidates.length)][2];
    words.push(next);
  }
  return words.join(" ");
}

// ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± (ÙÙ‚Ø· Ø§Ú¯Ø± ØªÙˆ blacklist Ù†Ø¨Ø§Ø´Ù‡ Ùˆ Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø®ÙˆØ¯Ø´ Ø¨Ù„Ø¯ Ù‡Ø³Øª Ù†Ø¨Ø§Ø´Ù‡)
function learnFromUser(input){
  const words = input.split(/\s+/);
  for(let i=0;i<words.length-2;i++){
    const triple = [words[i],words[i+1],words[i+2]];
    const wordSet = triple.map(w=>w.toLowerCase());
    // Ú†Ú© blacklist
    if(wordSet.some(w=>blacklist.includes(w))) continue;
    // Ú†Ú© Ø§ÛŒÙ†Ú©Ù‡ Ø®ÙˆØ¯Ø´ Ø¨Ù„Ø¯ Ù‡Ø³Øª
    const exists = model.some(m=>m[0]===triple[0] && m[1]===triple[1] && m[2]===triple[2]);
    if(exists) continue;
    model.push(triple);

    // Ø«Ø¨Øª Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± (ÙØ±Ø¶ Ú©Ù† API Ø³Ø§ÛŒØª ØªÙˆ /learn Ù‡Ø³Øª)
    fetch("/learn",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({triple})
    });
  }
}

function addMessage(text,sender){
  const div = document.createElement("div");
  div.className="msg "+sender;
  div.innerText=text;
  document.getElementById("chatbox").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

function send(){
  const input=document.getElementById("msg");
  const text=input.value.trim();
  if(!text) return;
  addMessage(text,"user");
  input.value="";

  learnFromUser(text); // ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ù…Ù†

  setTimeout(()=>{
    const reply = generateText(text);
    addMessage(reply,"bot");
  },300);
}
</script>
</body>
</html>
