<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<title>Chatran تک‌فایلی 🤖</title>
<style>
body{background:#0f172a;color:#e2e8f0;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;height:100vh;margin:0}
#chatbox{width:90%;max-width:600px;background:#1e293b;border-radius:12px;padding:15px;overflow-y:auto;flex-grow:1;margin-top:20px;display:flex;flex-direction:column}
.msg{margin:8px 0;padding:8px 12px;border-radius:10px;max-width:80%;word-wrap:break-word}
.user{background:#06b6d4;color:#000;align-self:flex-end}
.bot{background:#334155;color:#e2e8f0;align-self:flex-start}
#input-area{display:flex;width:90%;max-width:600px;margin:10px}
input{flex-grow:1;padding:10px;border-radius:8px;border:none;outline:none;background:#1e293b;color:white}
button{background:#06b6d4;border:none;color:black;border-radius:8px;margin-left:5px;padding:10px 15px;cursor:pointer}
button:hover{background:#22d3ee}
</style>
</head>
<body>
<h2>🤖 Chatran زنده</h2>
<div id="chatbox"></div>
<div id="input-area">
  <input id="msg" placeholder="چیزی بنویس..." autocomplete="off">
  <button onclick="send()">ارسال</button>
</div>

<script>
// مدل اولیه
let model = [
  ["سلام","چطوری","خوبه؟"],
  ["سازنده","تو","Chatran"]
];

// فهرست فحش‌ها (فارسی و انگلیسی)
const blacklist = [
  "گاییدم","کسکش","کیر","کص","کونی","کیرم","پوفک","fuck","shit","bitch","asshole","idiot","dumb","گایید"
];

// تابع تولید جمله
function generateText(prompt,length=10){
  let words = prompt.split(/\s+/);
  for(let i=0;i<length;i++){
    let lastTwo = words.slice(-2);
    let candidates = model.filter(m=>m[0]===lastTwo[0] && m[1]===lastTwo[1]);
    if(candidates.length===0) break;
    let next = candidates[Math.floor(Math.random()*candidates.length)][2];
    words.push(next);
  }
  return words.join(" ");
}

// یادگیری از کاربر (فقط اگر تو blacklist نباشه و چیزی که خودش بلد هست نباشه)
function learnFromUser(input){
  const words = input.split(/\s+/);
  for(let i=0;i<words.length-2;i++){
    const triple = [words[i],words[i+1],words[i+2]];
    const wordSet = triple.map(w=>w.toLowerCase());
    // چک blacklist
    if(wordSet.some(w=>blacklist.includes(w))) continue;
    // چک اینکه خودش بلد هست
    const exists = model.some(m=>m[0]===triple[0] && m[1]===triple[1] && m[2]===triple[2]);
    if(exists) continue;
    model.push(triple);

    // ثبت روی سرور (فرض کن API سایت تو /learn هست)
    fetch("/learn",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({triple})
    });
  }
}

function addMessage(text,sender){
  const div = document.createElement("div");
  div.className="msg "+sender;
  div.innerText=text;
  document.getElementById("chatbox").appendChild(div);
  div.scrollIntoView({behavior:"smooth"});
}

function send(){
  const input=document.getElementById("msg");
  const text=input.value.trim();
  if(!text) return;
  addMessage(text,"user");
  input.value="";

  learnFromUser(text); // یادگیری امن

  setTimeout(()=>{
    const reply = generateText(text);
    addMessage(reply,"bot");
  },300);
}
</script>
</body>
</html>
